using System;
using System.Threading.Tasks;
using BepInEx;
using BepInEx.Unity.IL2CPP;
using HarmonyLib;
using Reactor;
using Reactor.Networking.Attributes;
using Reactor.Utilities;

namespace VanillaEnhancements;

[BepInPlugin(Id, "Vanilla Enhancements", VersionString)]
[BepInProcess("Among Us.exe")]
[BepInDependency(ReactorPlugin.Id)]
[ReactorModFlags(Reactor.Networking.ModFlags.None)]
public class InvalidMessageError
{
    private static readonly ManualLogSource Logger = BepInEx.Logging.Logger.CreateLogSource("InvalidMessageError");

    private void Awake()
    {
        Logger.LogInfo("InvalidMessageError plugin loaded.");
        Harmony.CreateAndPatchAll(typeof(InvalidMessageError));
    }

    [HarmonyPatch(typeof(ChatController), "Update")]
    [HarmonyPostfix]
    private static void InnerNetClient_Update_Postfix()
    {
        // Проверяем, нажата ли клавиша (например, 'F1')
        if (Input.GetKeyDown(KeyCode.F1))
        {
            // Создаем неправильное сообщение
            byte[] invalidMessage = new byte[] { 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A };

            // Отправляем неправильное сообщение
            InnerNet.InnerNetClient.instance.SendMessage(invalidMessage, 0, invalidMessage.Length);
        }
    }
}
public partial class VanillaEnhancementsPlugin : BasePlugin
{
    public const string Id = "com.chipseq.vanillaenhancements";
    public const string VersionString = "1.6.1";

    // Всегда стабильная версия, без dev.
    public static bool IsDevRelease = false;

    public Harmony Harmony { get; } = new(Id);

    public override void Load()
    {
        VELogger.Info("VEnhance is loading...");

        // Отключённый апдейтер всегда возвращает стабильные данные.
        IsDevRelease = false;

        ReactorCredits.Register(
            "VEnhance",
            VersionString,
            false,
            ReactorCredits.AlwaysShow
        );

        ModConfig.Bind(Config);
        PlayerMuting.Setup();
        IL2CPPChainloader.Instance.Finished += ModCompatibility.Load;

        try
        {
            Harmony.PatchAll();
        }
        catch (Exception exception)
        {
            VELogger.Error($"An error occured while loading VEnhance-{VersionString} ({Id})");
            VELogger.Error(exception.Message);
        }

        VELogger.Info("VEnhance finished loading");
    }

    // Stub метода проверки dev-версии — ничего не делает.
    public static async Task<bool[]> CheckDevRelease()
    {
        // [isDev, updateAvailable]
        return new bool[] { false, false };
    }

    // Stub метода проверки GitHub — полностью отключен.
    static async Task<bool[]> HttpVersionExists(string url)
    {
        // [found, success, updateAvailable]
        return new bool[] { true, true, false };
    }
}
